#!/usr/bin/env ruby
#
# This script handles receiving emails in order to reprocess them, e.g. for group emails.
# Have a look at these resources:
#
#   * http://railscasts.com/episodes/313-receiving-email-with-mailman.
#   * https://github.com/titanous/mailman
#   * http://rubydoc.info/github/titanous/mailman/master/file/USER_GUIDE.md
#

require "rubygems"
require "bundler/setup"
require "mailman"

Mailman.config.logger = Logger.new("log/mailman.log")

Mailman::Application.run do

  to '%token%@wingolfsplattform.org' do
    
    begin
      Post.create_from_message(message)
    rescue Exception => e
      Mailman.logger.error "Exception occured while processing received email:\n#{message}"
      Mailman.logger.error [e, *e.backtrace].join("\n")
    end

  end
end


# This file is still in development.
# Try this using 
#
#   cat mailman_test.eml | script/mailman_server
